---
title: "Join benchmark"
output:
  html_document:
    self_contained: no
    includes:
      in_header: ga.html
---

This page presents results of [h2oai.github.io/db-benchmark](./index.html) _join_ task benchmark for various datasizes and various data characteristis. Data size on tabs corresponds to the LHS dataset of join, while RHS datasets are of the following sizes: _small_ (LHS/1e6), _medium_ (LHS/1e3), _big_ (LHS). As of now only 5 _basic_ questions has been implemented, and only 1e7 (0.6 GB) and 1e8 (6 GB) data sizes. 5 _advanced_ questions will follow, as well as 1e9 (60 GB) data size.

```{r opts, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, cache=FALSE)
```

```{r render}
report_name = "join"
# Rscript -e 'rmarkdown::render("join.Rmd", output_dir="public")' # has to be output_dir='public' as there is hardcode in benchplot for that path
```

```{r init, child="rmarkdown_child/init.Rmd"}
```

```{r links_plots}
link = function(data_name, q_group, report_name) {
  fnam = sprintf("%s.%s.png", data_name, q_group)
  path = file.path(report_name, "plots")
  sprintf("[%s](%s)", fnam, file.path(path, fnam))
}
```

## Join {.tabset .tabset-fade .tabset-pills}

```{r filter_task}
dt_task = lld[task=="join"]
by_data = function(dt, .in_rows, .task) {
  dt = dt[in_rows==as.character(.in_rows)]
  if (!nrow(dt)) return(invisible(NULL))
  wide = dcast(dt, data+in_rows+as.integer(as.character(k))+na+sorted+question ~ solution, value.var="time_sec_1")
  d = groupingsets(wide[!is.na(question)], by=c("data","in_rows","k","na","sorted","question"), j=lapply(.SD, sum), id=TRUE, sets=list(c("data","in_rows","k","na","sorted","question"), character(0)))
  setorderv(d, c("data","question"), na.last=TRUE)
  setcolorder(d, c("data","in_rows","k","na","sorted","question"))
  d[grouping==63L, c("in_rows"):=list(.in_rows)]
  d[, c("grouping","data"):=NULL]
  d[, "k" := NULL] ## ignored for join
  setnames(d, c("in_rows","na","sorted"), c("rows","NA_pct","pre_sorted"))
  kk(d)
}
```

Below timings are presented for a single dataset case having random order, no NAs (missing values).

```{r o_task_plot, message=FALSE}
path = file.path("public", report_name, "plots")
for (in_rows in c("1e7","1e8","1e9")) {
  for (data_name in paste("J1", in_rows, c("NA_0_0"), sep="_")) { # single data_name within in_rows, so far
    for (q_group in c("basic","advanced")) {
      benchplot(as.numeric(in_rows), task=report_name, data=data_name, timings=dt_task[question_group==q_group], code=join.code, exceptions=join.exceptions, colors=solution.colors, fnam=paste(data_name, q_group, "png", sep="."), path=path, .interactive=FALSE)
    }
  }
}
if (dev<-FALSE) {
  in_rows = "1e7"
  data_name = "J1_1e7_NA_0_0"
  q_group = "basic"
  benchplot(as.numeric(in_rows), task=report_name, data=data_name, timings=dt_task[question_group==q_group], code=join.code, exceptions=join.exceptions, colors=solution.colors, fnam=paste(data_name, q_group, "png", sep="."), path=path, .interactive=TRUE)
}
```

### 0.6 GB

#### <u>**Set of basic questions**</u>

![](public/join/plots/J1_1e7_NA_0_0.basic.png)  

---

#### <u>**Set of advanced questions**</u>

![](public/join/plots/J1_1e7_NA_0_0.advanced.png)  

---

#### <u>**Details table**</u>

Plots of all cases can be found at `r dt_task[in_rows=="1e7", .(q_grp_links=paste(link(unique(data), q_group=question_group, report_name=report_name), collapse=", ")), by=question_group][, paste(q_grp_links, collapse=", ")]`. Below first run timings.

```{r o_task_1e7_table}
by_data(dt_task, "1e7", report_name)
```

---

### 6 GB {.active}

#### <u>**Set of basic questions**</u>

![](public/join/plots/J1_1e8_NA_0_0.basic.png)  

---

#### <u>**Set of advanced questions**</u>

![](public/join/plots/J1_1e8_NA_0_0.advanced.png)  

---

#### <u>**Details table**</u>

Plots of all cases can be found at `r dt_task[in_rows=="1e8", .(q_grp_links=paste(link(unique(data), q_group=question_group, report_name=report_name), collapse=", ")), by=question_group][, paste(q_grp_links, collapse=", ")]`. Below first run timings.

```{r o_task_1e8_table}
by_data(dt_task, "1e8", report_name)
```

---

### 60 GB

#### <u>**Set of basic questions**</u>

![](public/join/plots/J1_1e9_NA_0_0.basic.png)  

---

#### <u>**Set of advanced questions**</u>

![](public/join/plots/J1_1e9_NA_0_0.advanced.png)  

---

#### <u>**Details table**</u>

Plots of all cases can be found at `r dt_task[in_rows=="1e9", .(q_grp_links=paste(link(unique(data), q_group=question_group, report_name=report_name), collapse=", ")), by=question_group][, paste(q_grp_links, collapse=", ")]`. Below first run timings.

```{r o_task_1e9_table}
by_data(dt_task, "1e9", report_name)
```

---

```{r environment, child="rmarkdown_child/environment.Rmd"}
```

------

```{r timetaken, child="rmarkdown_child/timetaken.Rmd"}
```

```{r status, child="rmarkdown_child/status.Rmd"}
```
