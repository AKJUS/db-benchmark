---
title: "Aggregation benchmark"
output:
  html_document:
    self_contained: no
    includes:
      in_header: ga.html
---

This page presents results of [h2oai.github.io/db-benchmark](./index.html) _groupby_ task benchmark for various datasizes and various data characteristis (cardinality, percentage of missing values, pre-sorted input). There are 10 different questions run for each input data, questions are categorized into two groups. _Basic_ questions refers to set of 5 questions designed by [Matt Dowle](https://twitter.com/MattDowle) (creator of [data.table](https://github.com/Rdatatable/data.table)) in 2014 [here](https://github.com/Rdatatable/data.table/wiki/Benchmarks-%3A-Grouping). _Advanced_ questions are 5 new questions meant to cover more complex queries, which are also less obvious to optimize.  

```{r opts, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, cache=FALSE)
```

```{r render}
report_name = "groupby"
# Rscript -e 'rmarkdown::render("groupby.Rmd", output_dir="public")' # has to be output_dir='public' as there is hardcode in benchplot for that path
```

```{r init, child="rmarkdown_child/init.Rmd"}
```

```{r links_plots}
link = function(x) sprintf("[%s](%s/%s.png)", x, "plots", gsub("G1_", "groupby.", x, fixed=TRUE))
```

## Groupby {.tabset .tabset-fade .tabset-pills}

```{r filter_task_groupby}
dt_task = lld[task=="groupby" & question_group=="basic"]
by_data = function(dt, .in_rows, .task) {
  dt = dt[in_rows==as.character(.in_rows)]
  if (!nrow(dt)) return(invisible(NULL))
  wide = dcast(dt, data+in_rows+as.integer(as.character(k))+na+sorted+question ~ solution, value.var="time_sec_1")
  d = groupingsets(wide[!is.na(question)], by=c("data","in_rows","k","na","sorted","question"), j=lapply(.SD, sum), id=TRUE, sets=list(c("data","in_rows","k","na","sorted","question"), character(0)))
  setorderv(d, c("data","question"), na.last=TRUE)
  setcolorder(d, c("data","in_rows","k","na","sorted","question"))
  d[grouping==63L, c("in_rows"):=list(.in_rows)]
  d[, c("grouping","data"):=NULL]
  setnames(d, c("in_rows","k","na","sorted"), c("rows","q1_grp.size","NA_pct","pre_sorted"))
  kk(d)
}
```

Below timings are presented for a single dataset case having random order, no NAs (missing values) and particular cardinality factor (group size question 1 `k=100`). To see timings for other cases scroll down to full timings table. If a solution is missing on particular data size timings table refer to benchplot for a reason and check its speed on smaller data size tab.

### 0.5 GB

```{r o_groupby1_plot}
for (fn in c("1e7_1e2_0_0","1e7_1e1_0_0","1e7_2e0_0_0","1e7_1e2_0_1")) {
  fnam = paste0("groupby.",fn,".png")
  unlink(file.path("public",report_name,"plots", fnam))
  benchplot(1e7, data=paste0("G1_",fn), timings=dt_task, code=groupby.code, colors=solution.colors, fnam=fnam, path=file.path("public",report_name,"plots"))
}
```
![](public/groupby/plots/groupby.1e7_1e2_0_0.png)  
&nbsp;  
Plots of all cases can be found at `r dt_task[in_rows=="1e7", paste(link(unique(data)), collapse=", ")]`. Below first run timings.

```{r o_groupby1_table}
by_data(dt_task, "1e7", "groupby")
```

### 5 GB

```{r o_groupby2_plot}
for (fn in c("1e8_1e2_0_0","1e8_1e1_0_0","1e8_2e0_0_0","1e8_1e2_0_1")) {
  fnam = paste0("groupby.",fn,".png")
  unlink(file.path("public",report_name,"plots", fnam))
  benchplot(1e8, data=paste0("G1_",fn), timings=dt_task, code=groupby.code, colors=solution.colors, fnam=fnam, path=file.path("public",report_name,"plots"))
}
```
![](public/groupby/plots/groupby.1e8_1e2_0_0.png)  
&nbsp;  
Plots of all cases can be found at `r dt_task[in_rows=="1e8", paste(link(unique(data)), collapse=", ")]`. Below first run timings.

```{r o_groupby2_table}
by_data(dt_task, "1e8", "groupby")
```

### 50 GB {.active}

```{r o_groupby3_plot}
for (fn in c("1e9_1e2_0_0","1e9_1e1_0_0","1e9_2e0_0_0","1e9_1e2_0_1")) {
  fnam = paste0("groupby.",fn,".png")
  unlink(file.path("public",report_name,"plots", fnam))
  benchplot(1e9, data=paste0("G1_",fn), timings=dt_task, code=groupby.code, colors=solution.colors, fnam=fnam, path=file.path("public",report_name,"plots"))
}
```
![](public/groupby/plots/groupby.1e9_1e2_0_0.png)  
&nbsp;  
Plots of all cases can be found at `r dt_task[in_rows=="1e9", paste(link(unique(data)), collapse=", ")]`. Below first run timings.

```{r o_groupby3_table}
by_data(dt_task, "1e9", "groupby")
```

```{r environment, child="rmarkdown_child/environment.Rmd"}
```

------

```{r timetaken, child="rmarkdown_child/timetaken.Rmd"}
```

```{r status, child="rmarkdown_child/status.Rmd"}
```
